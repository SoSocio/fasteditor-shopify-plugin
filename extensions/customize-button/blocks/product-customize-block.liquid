{%- comment -%}
  Product Customize Block
  Renders a customizable button for product customization.
  Only renders for products with 'fasteditor' tag or in design mode.
{%- endcomment -%}

{%- liquid
  # Block settings
  assign font = block.settings.text_font
  assign icon_type = block.settings.icon_type | default: 'none'
  assign icon_position = block.settings.icon_position | default: 'left'

  # Product variant data
  assign selected_variant = product.selected_or_first_available_variant
  assign is_variant_available = false
  if selected_variant
    assign is_variant_available = selected_variant.available
  endif
-%}

{%- capture variants_json -%}
[
{%- for variant in product.variants -%}
  {
    "id": "{{ variant.id }}",
    "available": {{ variant.available | json }}
  }{% unless forloop.last %},{% endunless %}
{%- endfor -%}
]
{%- endcapture -%}

{%- liquid

  # Button text and icon - always keep original text and icon
  assign display_icon_type = icon_type

  # App availability
  assign is_app_available = app.metafields.fasteditor_app.availability

  # Visibility check: only show for products with 'fasteditor' tag or in design mode
  assign show_button = false
  if request.design_mode or product.tags contains 'fasteditor'
    assign show_button = true
  endif
-%}

{%- if show_button -%}
  {%- comment -%} Scoped styles for this block instance {%- endcomment -%}
  <style>
    {{ font | font_face }}

    .fasteditor-customize-button-{{ block.id }} {
      --button-bg-color: {{ block.settings.bg_color }};
      --button-text-color: {{ block.settings.text_color }};
      --button-font-size: {{ block.settings.text_size }}px;
      --button-font-family: {{ font.family }}, {{ font.fallback_families }};
      --button-border-width: {{ block.settings.border_width }}px;
      --button-border-color: {{ block.settings.border_color }};
      --button-border-radius: {{ block.settings.border_radius }}px;
      --icon-gap: {{ block.settings.icon_gap}}px;
    }
  </style>

  {%- liquid
    # Prepare customize button attributes
    assign customize_button_disabled = false
    if is_app_available != true or is_variant_available != true
      assign customize_button_disabled = true
    endif
  -%}

  {%- capture customize_button_attributes -%}
    data-shop="{{ shop.permanent_domain | escape }}"
    data-handle="{{ product.handle | escape }}"
    data-section-id="{{ section.id }}"
    data-availability="{{ is_app_available | json }}"
    data-variant-available="{{ is_variant_available | json }}"
    data-initial-variant-id="{{ selected_variant.id }}"
    data-variants='{{ variants_json | escape }}'
    data-redirect="{{ block.settings.enable_cart_redirect }}"
    data-loading-text="{{ block.settings.loading_text | escape }}"
    data-adding-to-cart-text="{{ block.settings.adding_to_cart_text | escape }}"
    data-added-to-cart-text="{{ block.settings.added_to_cart_text | escape }}"
    data-error-text="{{ block.settings.error_text | escape }}"
    data-sold-out-text="{{ 'customize_button.sold_out' | t }}"
  {%- endcapture -%}

  {%- comment -%} Web component wrapper {%- endcomment -%}
  {%- liquid
    # Determine button text (always original)
    assign button_text = block.settings.text
  -%}
  {%- render 'button-customize',
    button_text: button_text,
    button_attributes: customize_button_attributes,
    is_disabled: customize_button_disabled,
    icon_type: display_icon_type,
    icon_position: icon_position,
    icon_color: block.settings.icon_color,
    icon_size: block.settings.icon_size,
    icon_custom_image: block.settings.icon_custom_image,
  -%}
{%- endif -%}

{% schema %}
{
  "name": "t:blocks.customize-button.name",
  "target": "section",
  "available_if": "{{ app.metafields.fasteditor_app.paid }}",
  "enabled_on": {
    "templates": [
      "product"
    ]
  },
  "settings": [
    {
      "type": "header",
      "content": "t:blocks.customize-button.settings.button_text.header"
    },
    {
      "type": "text",
      "id": "text",
      "label": "t:blocks.customize-button.settings.button_text.text",
      "default": "Customize"
    },
    {
      "type": "font_picker",
      "id": "text_font",
      "label": "t:blocks.customize-button.settings.button_text.text_font",
      "default": "helvetica_n4"
    },
    {
      "type": "range",
      "id": "text_size",
      "min": 8,
      "max": 64,
      "step": 1,
      "unit": "px",
      "label": "t:blocks.customize-button.settings.button_text.text_size",
      "default": 16
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "t:blocks.customize-button.settings.button_text.text_color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "t:blocks.customize-button.settings.button_appearance.header"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "t:blocks.customize-button.settings.button_appearance.bg_color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "border_width",
      "min": 0,
      "max": 99,
      "step": 1,
      "unit": "px",
      "label": "t:blocks.customize-button.settings.button_appearance.border_width",
      "default": 0
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "t:blocks.customize-button.settings.button_appearance.border_color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "border_radius",
      "min": 0,
      "max": 99,
      "step": 1,
      "unit": "px",
      "label": "t:blocks.customize-button.settings.button_appearance.border_radius",
      "default": 0
    },
    {
      "type": "header",
      "content": "t:blocks.customize-button.settings.icon_settings.header"
    },
    {
      "type": "select",
      "id": "icon_type",
      "label": "t:blocks.customize-button.settings.icon_settings.icon_type.label",
      "options": [
        {
          "value": "none",
          "label": "t:blocks.customize-button.settings.icon_settings.icon_type.options.none"
        },
        {
          "value": "pen",
          "label": "t:blocks.customize-button.settings.icon_settings.icon_type.options.pen"
        },
        {
          "value": "brush",
          "label": "t:blocks.customize-button.settings.icon_settings.icon_type.options.brush"
        },
        {
          "value": "image",
          "label": "t:blocks.customize-button.settings.icon_settings.icon_type.options.image"
        },
        {
          "value": "images",
          "label": "t:blocks.customize-button.settings.icon_settings.icon_type.options.images"
        },
        {
          "value": "link",
          "label": "t:blocks.customize-button.settings.icon_settings.icon_type.options.link"
        },
        {
          "value": "settings",
          "label": "t:blocks.customize-button.settings.icon_settings.icon_type.options.settings"
        },
        {
          "value": "custom",
          "label": "t:blocks.customize-button.settings.icon_settings.icon_type.options.custom"
        }
      ],
      "default": "none"
    },
    {
      "type": "image_picker",
      "id": "icon_custom_image",
      "label": "t:blocks.customize-button.settings.icon_settings.custom_icon_image",
      "info": "t:blocks.customize-button.settings.icon_settings.custom_icon_image_info"
    },
    {
      "type": "color",
      "id": "icon_color",
      "label": "t:blocks.customize-button.settings.icon_settings.icon_color",
      "default": "#ffffff",
      "info": "t:blocks.customize-button.settings.icon_settings.icon_color_info"
    },
    {
      "type": "range",
      "id": "icon_size",
      "min": 8,
      "max": 64,
      "step": 1,
      "unit": "px",
      "label": "t:blocks.customize-button.settings.icon_settings.icon_size",
      "default": 20,
      "info": "t:blocks.customize-button.settings.icon_settings.icon_size_info"
    },
    {
      "type": "range",
      "id": "icon_gap",
      "min": 0,
      "max": 32,
      "step": 1,
      "unit": "px",
      "label": "t:blocks.customize-button.settings.icon_settings.icon_gap",
      "default": 8,
      "info": "t:blocks.customize-button.settings.icon_settings.icon_gap_info"
    },
    {
      "type": "select",
      "id": "icon_position",
      "label": "t:blocks.customize-button.settings.icon_settings.icon_position.label",
      "options": [
        {
          "value": "left",
          "label": "t:blocks.customize-button.settings.icon_settings.icon_position.options.left"
        },
        {
          "value": "right",
          "label": "t:blocks.customize-button.settings.icon_settings.icon_position.options.right"
        }
      ],
      "default": "left",
      "info": "t:blocks.customize-button.settings.icon_settings.icon_position.info"
    },
    {
      "type": "header",
      "content": "t:blocks.customize-button.settings.button_state_texts.header"
    },
    {
      "type": "text",
      "id": "loading_text",
      "label": "t:blocks.customize-button.settings.button_state_texts.loading_text",
      "default": "Loading...",
      "info": "t:blocks.customize-button.settings.button_state_texts.loading_text_info"
    },
    {
      "type": "text",
      "id": "adding_to_cart_text",
      "label": "t:blocks.customize-button.settings.button_state_texts.adding_to_cart_text",
      "default": "Adding to cart...",
      "info": "t:blocks.customize-button.settings.button_state_texts.adding_to_cart_text_info"
    },
    {
      "type": "text",
      "id": "added_to_cart_text",
      "label": "t:blocks.customize-button.settings.button_state_texts.added_to_cart_text",
      "default": "Added to cart",
      "info": "t:blocks.customize-button.settings.button_state_texts.added_to_cart_text_info"
    },
    {
      "type": "text",
      "id": "error_text",
      "label": "t:blocks.customize-button.settings.button_state_texts.error_text",
      "default": "Error",
      "info": "t:blocks.customize-button.settings.button_state_texts.error_text_info"
    },
    {
      "type": "header",
      "content": "t:blocks.customize-button.settings.button_behavior.header"
    },
    {
      "type": "checkbox",
      "id": "enable_cart_redirect",
      "default": true,
      "label": "t:blocks.customize-button.settings.button_behavior.enable_cart_redirect"
    }
  ]
}
{% endschema %}
